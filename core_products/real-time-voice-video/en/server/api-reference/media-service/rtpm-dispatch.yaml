openapi: 3.0.0
info:
  title: open-api-desc
  version: 1.0.0
  contact: { name: Real-time Voice/Video API Support, email: support@zegocloud.com }

tags:
  - name: media-service

servers:
  $ref: '../shared-components.yaml#/servers'

paths:
  /:
    get:
      tags: [media-service]
      summary: RTMPDispatchV2
      description: |
        Call this API to initiate RTMP stream dispatching, supporting both "pull" and "push" dispatch modes.

        When you need to perform RTMP stream publishing or playing from ZEGOCLOUD's video cloud service through the RTMP protocol, you can use this API to obtain the RTMP publishing or playing nodes. After the developer passes the Stream ID (StreamId), dispatch mode (Type), client IP (ClientIP), and sequence number (Sequence) from the client, the ZEGOCLOUD media server (RTC service) returns a dispatch result set for the client to publish or play streams.

        For example, when performing RTMP stream publishing through third-party publishing tools such as OBS, you need to perform publishing dispatch; when you need a third-party player to pull RTMP streams for playback, you need to perform playing dispatch.

        <Warning title="Note">
        For first-time use of this API, please contact ZEGOCLOUD Technical Support for configuration.
        </Warning>
        <Note title="Rate Limit">For the same AppID: 40 times/second</Note>
        ## Legacy API Usage Instructions

        <Accordion title="Using RTMPDispatch to access ZEGOCLOUD server" defaultOpen="false">
        <Note title="Note">


        The difference between **RTMPDispatchV2 (recommended)** and **RTMPDispatch** is, when accessing the ZEGOCLOUD server:

        - Using `RTMPDispatchV2`, the ZEGOCLOUD server returns Data in URL format.
        - Using `RTMPDispatch`, the ZEGOCLOUD server returns Data in IP:Port format.

        </Note>



        Request URL: `https://rtc-api.zego.im/?Action=RTMPDispatch`

        Response example:

        ```json
        {
            "Code":0,
            "Message":"ok",
            "RequestId":"5094436160208407316",
            "Data":[
                "81.69.49.115:1935"
            ]
        }
        ```
        </Accordion>
        <br/>

        <Note title="Note">
        In the test environment (see the IsTest common parameter description for details), the Stream ID must be prefixed with "zegotest-AppId-". For example, if the Stream ID is "test" and the AppId is "123456789" in the test environment, the Stream ID should be "zegotest-123456789-test".
        </Note>
      operationId: rtpm-dispatch
      parameters:
        - name: Action
          in: query
          description: |
            > API prototype parameters
            >
            > https://rtc-api.zego.im?Action=RTMPDispatchV2
          required: true
          schema: { type: string, enum: [RTMPDispatchV2] }
          style: form
          explode: true
        - $ref: '../shared-components.yaml#/components/parameters/AppId'
        - $ref: '../shared-components.yaml#/components/parameters/SignatureNonce'
        - $ref: '../shared-components.yaml#/components/parameters/Timestamp'
        - $ref: '../shared-components.yaml#/components/parameters/Signature'
        - $ref: '../shared-components.yaml#/components/parameters/SignatureVersion'
        - name: StreamId
          in: query
          required: true
          schema: { type: string }
          description: |
            Stream ID, a string with a maximum length of 256 characters.
            - The Stream ID is defined by you.
            - When publishing streams, it must be globally unique within the entire AppID. If different users publish streams with the same stream name within the same AppID, the later publishing user will fail to publish.
            - Only supports numbers, English characters, '-', and '_'.
        - name: Sequence
          in: query
          required: true
          schema: { type: Int64 }
          description: Request sequence number; only used for request reconciliation. Using a timestamp (millisecond level) is recommended.
        - name: Type
          in: query
          required: true
          schema: { type: string }
          description: |
            Dispatch mode:
            - pull: Get the RTMP playing node
            - push: Get the RTMP publishing node
        - name: ClientIP
          in: query
          required: false
          schema: { type: string }
          description: |
            Optional. If provided, pass the client IP address, for example: 119.23.242.129.

            > **Note**
            >
            > IPv6 format IP addresses are not currently supported.
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RTMPDispatchV2Response'

components:
  schemas:
    RTMPDispatchV2Response:
      type: object
      properties:
        Code:
          type: integer
          format: number
          description: |
            Return code.
            The following only lists some return codes related to the API business logic. For the complete return codes, please refer to [Global Return Codes](/real-time-video-server/api-reference/return-codes).
            <table>
              <thead>
                <tr><th>Return Code</th><th>Description</th><th>Suggested Action</th></tr>
              </thead>
              <tbody>
                <tr><td>1010, 30002</td><td>API call rate too high.</td><td>Please reduce the API request frequency.</td></tr>
                <tr><td>1001</td><td>Dispatch failed.</td><td>Please contact ZEGOCLOUD Technical Support.</td></tr>
                <tr><td>1002</td><td>Publishing node is empty.</td><td>Please contact ZEGOCLOUD Technical Support.</td></tr>
                <tr><td>1003</td><td>Playing node is empty.</td><td>Please contact ZEGOCLOUD Technical Support.</td></tr>
                <tr><td>1005</td><td>App is not online.</td><td>Please contact ZEGOCLOUD Technical Support.</td></tr>
                <tr><td>1006</td><td>Invalid parameter.</td><td>Please contact ZEGOCLOUD Technical Support.</td></tr>
                <tr><td>30003</td><td>Internal error.</td><td>Please contact ZEGOCLOUD Technical Support.</td></tr>
                <tr><td>30004</td><td>Incorrect isTest parameter.</td><td>Please check if the isTest common parameter is correct.</td></tr>
                <tr><td>30005</td><td>Invalid AppId.</td><td>Please check if the AppId is correct.</td></tr>
                <tr><td>30009</td><td>Invalid StreamId, stream name does not conform to specifications.</td><td>Please check if the StreamId conforms to the stream name encoding specifications.</td></tr>
                <tr><td>30010</td><td>Invalid dispatch action.</td><td>Please check if the Type is correct.</td></tr>
                <tr><td>30011</td><td>Invalid client IP address.</td><td>Please check if the ClientIP is correct.</td></tr>
              </tbody>
            </table>
          example: 0
        Message:
          type: string
          description: Operation result description
          example: "ok"
        RequestId:
          type: string
          description: Request ID
          example: "5094436160208407316"
        Data:
          type: object
          description: |
            RTMP publishing or playing node.

            > **Note**
            >
            > After obtaining this node, please initiate stream publishing or playing within 2 hours, otherwise the node may be occupied or taken offline. Therefore, it is recommended to call this API each time you perform RTMP stream publishing or playing to obtain the latest node.
          example: ["rtmp://81.69.49.115:1935/1540531164/caodantest"]
