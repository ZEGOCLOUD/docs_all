---
articleID: 1188
date: "2024-01-02"
---
# Using CDN for Live Streaming

---

## Feature Overview

ZEGO Express SDK supports publishing streams to CDN (Content Delivery Network), including two features: relay-to-CDN and direct-to-CDN. Based on this feature, developers can connect RTC products and CDN live streaming products, making it convenient for users to directly watch and listen to live content from web pages or third-party players. To ensure security, CDN authentication is enabled by default when publishing to CDN.

To prevent attackers from stealing or forging your publishing URL addresses, you can refer to [CDN Stream Publishing Authentication](/real-time-video-android-java/live-streaming/cdn-stream-publishing-authentication) to improve the security of your publishing usage.

<Warning title="Attention">
When initiating relay-to-CDN or direct-to-CDN, please note that CDN has requirements for audio and video formats. The publishing end supports AAC and MP3 for audio, and H.264 and H.265 (requires CDN configuration) for video.
</Warning>

### Relay-to-CDN

Relay-to-CDN refers to the process of pushing audio and video streams from ZEGO real-time audio and video cloud to ZEGO's own CDN or third-party CDN.

<Frame width="512" height="auto" caption=""><img src="https://doc-media.zego.im/sdk-doc/Pics/Common/ZegoExpressEngine/relay_cdn.png" /></Frame>

Relay-to-CDN includes the following three methods:

<table>

<tbody><tr>
<th>Relay Method</th>
<th>Description</th>
</tr>
<tr>
<td>Default Relay-to-CDN</td>
<td>All live streams published by users using ZEGO Express SDK to ZEGO real-time audio and video cloud will be relayed to CDN. Currently only supports ZEGO's own CDN.</td>
</tr>
<tr>
<td>Bypass Relay-to-CDN</td>
<td>Developers can customize and specify streams on ZEGO real-time audio and video cloud to relay to CDN, supporting ZEGO's own CDN and third-party CDNs.</td>
</tr>
<tr>
<td>Mixing Relay-to-CDN</td>
<td>In mixing scenarios, output streams can also be relayed to CDN, supporting ZEGO's own CDN and third-party CDNs.</td>
</tr>
</tbody></table>

### Direct-to-CDN

Direct-to-CDN refers to the process of pushing audio and video streams directly from the local client to the CDN. Users can directly watch from web pages or third-party players by playing the stream URL address. However, since the direct-to-CDN function does not go through ZEGO real-time audio and video cloud during network transmission, developers cannot use ZEGO's real-time audio and video services.

<Frame width="512" height="auto" caption="">
  <img src="https://doc-media.zego.im/sdk-doc/Pics/Android/streamByCdn/direct_to_cdn.png" />
</Frame>

### Feature Comparison

The descriptions and usage scenarios of the two functions are as follows:

<table>

<tbody><tr>
<th>Feature</th>
<th>Description</th>
<th>Usage Scenarios</th>
</tr>
<tr>
<td>Relay-to-CDN (Recommended)</td>
<td>Publishing first goes through ZEGO real-time audio and video cloud, then is relayed to CDN by ZEGO real-time audio and video cloud. Can use real-time audio and video services provided by ZEGO, suitable for scenarios requiring co-hosting interaction.</td>
<td>Developers have business cooperation with third-party CDNs and want to use the original third-party CDN streaming media network distribution services while also using ZEGO Express SDK for real-time co-hosting interaction. Suitable for business scenarios with co-hosting interaction requirements, such as show live streaming, voice chat rooms, etc.</td>
</tr>
<tr>
<td>Direct-to-CDN</td>
<td>Publishing does not go through ZEGO real-time audio and video cloud, directly pushes to CDN. Cannot use real-time audio and video services provided by ZEGO, suitable for single live streaming scenarios (no interaction).</td>
<td>Suitable for developers who do not need to use real-time co-hosting interaction and other services, such as e-commerce live streaming, game live streaming, large classes, etc.</td>
</tr>
</tbody></table>



















## Prerequisites

Before using CDN for live streaming, please ensure:

- You have created a project in the [ZEGO Console](https://console.zego.im) and applied for a valid AppID and AppSign. For details, please refer to [Console - Project Information](/console/project-info).
- You have integrated ZEGO Express SDK in your project and implemented basic audio and video publish/play stream functionality. For details, please refer to [Quick Start - Integration](/real-time-video-android-java/quick-start/integrating-sdk) and [Quick Start - Implementation](/real-time-video-android-java/quick-start/implementing-video-call).


<Warning title="Attention">


The CDN live streaming feature is not enabled by default. Please enable it yourself in the [ZEGO Console](https://console.zego.im) before use (for enabling steps, please refer to "CDN" in [Project Management - Service Configuration](/console/service-configuration/activate-cdn-service)), or contact ZEGO Technical Support to enable it.
</Warning>

## Example Source Code Download

Please refer to [Download Example Source Code](/real-time-video-android-java/quick-start/run-example-code) to get the source code.

For related source code, please check the files in the "/ZegoExpressExample/AdvancedStreaming/src/main/java/im/zego/advancedstreaming/streamByCdn" directory.

## Relay-to-CDN

<Note title="Description">
If you choose to use the direct-to-CDN feature, you do not need to perform all steps in this section. Please refer to [Direct-to-CDN](/real-time-video-android-java/live-streaming/using-cdn-for-live-streaming).
</Note>

### Initialize and Login to Room

Please refer to [Quick Start - Implementation](/real-time-video-android-java/quick-start/implementing-video-call) for "Create Engine" and "Login to Room".

### Start Publishing Stream

Please refer to [Quick Start - Implementation](/real-time-video-android-java/quick-start/implementing-video-call) for "Publish Stream".

### Start Relay-to-CDN

After successful publishing, call the [addPublishCdnUrl](@addPublishCdnUrl) interface to add a dynamically relayed CDN URL, which allows you to dynamically relay audio and video streams that have been successfully published to ZEGO real-time cloud to third-party CDNs. The supported relay address format is "rtmp".

<Note title="Description">


- If developers need to relay to multiple third-party CDN providers, they can call the [addPublishCdnUrl](@addPublishCdnUrl) interface multiple times using the same stream ID (URLs need to be different).
- After developers relay to multiple third-party CDNs, they also need to call multiple times to stop all relayed streams when stopping relay.
- After developers relay to multiple third-party CDNs, they can obtain status change notifications for each relayed stream from the list parameter of the CDN relay status callback [onPublisherRelayCDNStateUpdate](@onPublisherRelayCDNStateUpdate).
</Note>











```java
// After successful publishing, start relay to CDN

// Stream ID used when publishing
String streamID = "STREAM_ID";
// CDN address that needs to be relayed. Developers should fill in according to the actual URL. streamID is the stream name for publishing and can be customized
String URL = "rtmp://publishing domain name/access point/streamID";
engine.addPublishCdnUrl(streamID, URL, new IZegoPublisherUpdateCdnUrlCallback() {
    @Override
    public void onPublisherUpdateCdnUrlResult(int errorCode) {
    if(errorCode == 0) {
        // Relay successful
        } else {
            // Relay failed, possibly due to network reasons causing relay request sending to fail
        }
    }
});
```

### (Optional) Listen to CDN Relay Status Notifications

#### Add/Remove Relay CDN Address Status Callback

Developers can register [onPublisherRelayCDNStateUpdate](@onPublisherRelayCDNStateUpdate) to get add/remove relay CDN address status callbacks. After ZEGO RTC server relays audio and video streams to CDN, if the CDN relay status changes, such as relay stopping or relay retrying, this callback will be received.

<Note title="Description">


Developers can use this callback to determine whether the audio and video streams relayed to CDN are normal:
- If not normal, further locate the cause of the abnormal audio and video streams relayed to CDN based on the abnormal reason, and implement corresponding disaster recovery strategies.
- If you do not understand the cause of the abnormality, you can contact ZEGO Technical Support to analyze the specific cause of the abnormality.
</Note>

```java
engine.setEventHandler(new IZegoEventHandler() {
    @Override
    public void onPublisherRelayCDNStateUpdate(String streamID, ArrayList<ZegoStreamRelayCDNInfo> infoList) {
    super.onPublisherRelayCDNStateUpdate(streamID, infoList);
    }
}
```


#### Relay CDN Information Details

Relay CDN information [ZegoStreamRelayCDNInfo](@-ZegoStreamRelayCDNInfo) includes the URL of the CDN publishing stream, relay status, reason for relay status change, and time when the status occurred. All parameters in [ZegoStreamRelayCDNInfo](@-ZegoStreamRelayCDNInfo) are as follows:

<table>

<tbody><tr>
<th>Parameter Name</th>
<th>Description</th>
</tr>
<tr>
<td>url</td>
<td>URL of the CDN publishing stream.</td>
</tr>
<tr>
<td>state</td>
<td>Relay status.</td>
</tr>
<tr>
<td>updateReason</td>
<td>Reason for relay status change.</td>
</tr>
<tr>
<td>stateTime</td>
<td>Time when the status occurred.</td>
</tr>
</tbody></table>

Among them, state values are as follows:

<table>

<tbody><tr>
<th>Enumeration Value</th>
<th>Description</th>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_STATE_NO_RELAY</td>
<td>No relay status, in this state before relay. If the relay process has continuous abnormalities, such as incorrect relay address, it will enter the no relay state.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_STATE_RELAY_REQUESTING</td>
<td>Requesting relay status. After the relay operation is successfully executed, it will enter the requesting relay status. Usually this status is used for application interface display. If there is an interruption due to poor network quality, the SDK will internally retry and return to the requesting relay status.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_STATE_RELAYING</td>
<td>Relaying status. Entering this status indicates that relay has succeeded.</td>
</tr>
</tbody></table>

updateReason values are as follows:

<table>

<tbody><tr>
<th>Enumeration Value</th>
<th>Description</th>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_NONE</td>
<td>None.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_SERVER_ERROR</td>
<td>Server error.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_HANDSHAKE_FAILED</td>
<td>Handshake failed.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_ACCESS_POINT_ERROR</td>
<td>Access point error.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_CREATE_STREAM_FAILED</td>
<td>Create stream failed.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_BAD_NAME</td>
<td>Stream ID is invalid.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_CDN_SERVER_DISCONNECTED</td>
<td>CDN server actively disconnected.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_DISCONNECTED</td>
<td>Actively disconnected.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_ALL_INPUT_STREAM_CLOSED</td>
<td>All input stream sessions of the mixed stream are closed.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_ALL_INPUT_STREAM_NO_DATA</td>
<td>All input streams of the mixed stream have no data.</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_SERVER_INTERNAL_ERROR</td>
<td>Mixing server internal error.</td>
</tr>
</tbody></table>

### Stop Relay

Call the [removePublishCdnUrl](@removePublishCdnUrl) interface to remove the dynamically relayed CDN URL. **When calling the [removePublishCdnUrl](@removePublishCdnUrl) interface to stop relay, please ensure that the current stream streamID exists.**

<Warning title="Attention">


This interface will not stop the audio and video streams published to ZEGO real-time audio and video cloud.
</Warning>

```java
// Stream ID used when publishing
String streamID = "STREAM_ID";
// CDN address that needs to stop relay. Developers should fill in according to the actual URL. streamID is the stream name for publishing
String URL = "rtmp://publishing domain name/access point/streamID";
engine.removePublishCdnUrl(streamID, URL, new IZegoPublisherUpdateCdnUrlCallback() {
    @Override
    public void onPublisherUpdateCdnUrlResult(int errorCode) {
        if(errorCode == 0) {
        // Stop relay successful
        } else {
            // Stop relay failed, possibly due to network reasons causing stop relay request sending to fail
        }
    }
});
```

## Direct-to-CDN

<Note title="Description">


If you choose to use the relay-to-CDN feature, you do not need to perform all steps in this section. Please refer to [Relay-to-CDN](/real-time-video-android-java/live-streaming/using-cdn-for-live-streaming).
</Note>

### Start Direct-to-CDN

Before publishing, call the [enablePublishDirectToCDN](@enablePublishDirectToCDN) interface to publish audio and video streams directly to CDN.

<Warning title="Attention">


- After calling the [enablePublishDirectToCDN](@enablePublishDirectToCDN) interface, calling [addPublishCdnUrl](@addPublishCdnUrl) and [removePublishCdnUrl](@removePublishCdnUrl) to dynamically relay to CDN will no longer take effect, because these two interfaces relay or stop relaying audio and video streams from ZEGO real-time audio and video cloud to CDN. If audio and video streams are published directly to CDN, they cannot be dynamically relayed to CDN through ZEGO real-time audio and video cloud.
- If calling the [enablePublishDirectToCDN](@enablePublishDirectToCDN) interface returns error code 1000038, possible problems include: domain name configuration error, media network exception, or media network connection is empty. Please contact ZEGO Technical Support.
</Warning>


```java
ZegoCDNConfig config = new ZegoCDNConfig();
// URL needs to be filled in by developers according to actual conditions. streamID is the stream name for publishing and can be customized
config.url = "rtmp://publishing domain name/access point/streamID";
engine.enablePublishDirectToCDN(true, config);
engine.startPublishingStream("STREAM_ID");
```

### Stop Direct-to-CDN

To stop direct-to-CDN, call the [stopPublishingStream](@stopPublishingStream) interface to stop publishing.

After stopping publishing, if the next publishing does not need direct-to-CDN, you can call the [enablePublishDirectToCDN](@enablePublishDirectToCDN) interface and pass "false" to turn off the direct-to-CDN feature. Calling this interface during publishing will not affect the current publishing.

```java
engine.stopPublishingStream();
ZegoCDNConfig config = new ZegoCDNConfig();
engine.enablePublishDirectToCDN(false, config);
```

## Audience Play Stream

- When the publishing end publishes directly to CDN, the playing end can directly play the stream by streamID. Please refer to [Quick Start - Implementation](/real-time-video-android-java/quick-start/implementing-video-call) for "Play Stream".

- After audio and video streams are successfully relayed to CDN, when developers want users to play streams from CDN, they need to use the custom play stream method with URL, and cannot play streams by stream ID. For URL play stream operation steps, please refer to "1 Configure Play Stream Parameters" and "2 Start Playing Stream" in [Playing Stream by URL](/real-time-video-android-java/live-streaming/playing-stream-by-url).
