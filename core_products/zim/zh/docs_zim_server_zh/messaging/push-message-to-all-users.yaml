openapi: 3.0.0
info:
  title: open-api-desc
  version: 1.0.0
  contact:
    name: ZEGO Support
    email: support@zegocloud.com

servers:
  $ref: '../shared-components.yaml#/servers'

tags:
  - messaging

paths:
  /:
    post:
      tags: [messaging]
      summary: 全员推送
      description: |
        全员推送，是指向所有在线用户（包括消息发送用户自己）、离线用户发送特定内容的消息，如文本、图片等。本功能适用于全员活动公告、送礼跨房间飘屏等场景。

        - 在线用户：登录 ZIM 并且心跳未超时的用户。
        - 离线用户：登录 ZIM 并上报 ZPNsPushId 之后，心跳超时的用户。
        <Note title="说明">
        - 如需使用本功能，请开通 ZIM 专业版或旗舰版服务。
        - 通过本接口发送的消息不会导致会话产生，也不会被保存。
        </Note>
        消息接收用户仅通过以下 ZIM SDK 的回调接口，接收全员推送的消息，得知消息由哪位用户发出。

        | iOS-25% | Android-25% | macOS-25% | Windows-25% |
        |-----|---------|-------|---------|
        | [broadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_ios~protocol~ZIMEventHandler#zim-broadcast-message-received) | [onBroadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~java_android~class~ZIMEventHandler#on-broadcast-message-received) | [broadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_macos~protocol~ZIMEventHandler#zim-broadcast-message-received) | [onBroadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~cpp_windows~class~ZIMEventHandler#on-broadcast-message-received) |
        
        | Web-25% | 小程序-25% | Flutter-25% | React Native-25% |
        |---------|-----|--------|--------------|
        | [broadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~javascript_web~interface~ZIMEventHandler#broadcast-message-received) | [broadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~javascript_wxxcx~interface~ZIMEventHandler#broadcast-message-received) | [onBroadcastMessageReceived](https://pub.dev/documentation/zego_zim/latest/zego_zim/ZIMEventHandler/onBroadcastMessageReceived.html) | [broadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~javascript_react-native~interface~ZIMEventHandler#broadcast-message-received) |
        
        | uni-app \| uni-app x-25% | HarmonyOS-25% |
        |---------|-----------|
        | [broadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~javascript_uni-app~interface~ZIMEventHandler#broadcast-message-received) | [broadcastMessageReceived](https://doc-zh.zego.im/article/api?doc=zim_API~javascript_harmony~interface~ZIMEventHandler#broadcast-message-received) | |
        
        <Note title="说明">
          参数 FromUserId 仅支持数字，英文字符和 `'!'，'#'，'$'，'%'，'&'，'('，')'，'+'，'-'，':'，';'，'<'，'='，'.'，'>'，'?'，'@'，'['，']'，'^'，'_'，' '，'{'，'}'，'|'，'~'`。
          
          如果发送方使用的 SDK 版本（版本说明请参考 [发布日志](/zim-android/client-sdks/zim-release-notes)）低于 `2.0.0`，ZIM 服务端对应的仅支持 `MessageType` 为 `2` 的 Command 类型消息，不支持其他类型。<br/>为了给开发者带来更好的体验，ZEGO 推荐开发者使用最新版本的 SDK。
          
          消息接收方的 SDK 版本必须为 2.10.0 或以上，才能接受全员推送消息。
        </Note>
        <Note title="说明">调用频率限制：1 次/秒，每 24 小时内仅限 100 次，如需调整，请联系 ZEGO 技术支持。</Note>
      operationId: push-message-to-all-users
      parameters:
        - name: Action
          in: query
          description: |
            > 接口原型参数
            >
            > https://zim-api.zego.im/?Action=SendMessageToAllUsers
          required: true
          schema:
            type: string
            enum: [SendMessageToAllUsers]
          style: form
          explode: true
        - $ref: '../shared-components.yaml#/components/parameters/AppId'
        - $ref: '../shared-components.yaml#/components/parameters/SignatureNonce'
        - $ref: '../shared-components.yaml#/components/parameters/Timestamp'
        - $ref: '../shared-components.yaml#/components/parameters/SignatureVersion'
        - $ref: '../shared-components.yaml#/components/parameters/Signature'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageToAllUsersRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageToAllUsersResponse'

components:
  schemas:
    SendMessageToAllUsersRequest:
      type: object
      required: [FromUserId, MessageType, MessageBody]
      properties:
        FromUserId:
          type: string
          description: 发送方的用户 ID（已在客户端调用 login 方法登录 ZIM 服务，或已调用 [服务端 API](/zim-server/user/batch-register-users) 完成注册）。
          maxLength: 32
          example: "u1"
        MessageType:
          type: number
          description: 消息类型，全员推送的适用类型请参考 [MessageBody 说明](/zim-server/messaging/messagebody-introduction)。
          example: 1
        MessageBody:
          type: object
          description: 消息内容，具体参数格式请参考 [MessageBody 说明](/zim-server/messaging/messagebody-introduction)。
          example:
            Message: "hello world"
            ExtendedData: "s"
        SubMsgType:
          type: number
          description: 具体的自定义类型。值由开发者定义，取值范围为 [0,200]。当 MessageType 为自定义消息时，才需赋值此参数。
          example: 0
        PushType:
          type: number
          description: |
            推送类别：
            - 0：对在线用户进行在线推送。
            - 1：对在线用户进行在线推送，对离线用户进行离线推送。
            - 2：对所有上报了 ZPNsPushId 的用户进行离线推送。
          example: 0
    SendMessageToAllUsersResponse:
      type: object
      properties:
        Code:
          type: number
          description: |
            返回码。

            > **说明**
            >
            > 当您发起请求同时向多个用户发送消息时：
            > - 如果只需成功向 1 个或以上的用户发送消息，Code 都会返回 0，表示成功。此时请参考 ErrorList 中的具体信息，确认操作结果，了解是否向部分用户发送消息失败。
            > - 如果向所有用户发送消息都失败，Code 会返回相关返回码，具体请参考 [全局返回码](/zim-server/return-codes)。

            以下仅列出了接口业务逻辑相关的返回码，完整返回码请参考 [全局返回码](/zim-server/return-codes)。

            <table>
            <tbody><tr>
            <th>返回码</th>
            <th>说明</th>
            <th>处理建议</th>
            </tr>
            <tr>
            <td>660000002</td>
            <td>输入参数错误。</td>
            <td>请检查输入的参数。</td>
            </tr>
            <tr>
            <td>660400001</td>
            <td>输入的消息大小超出限制。</td>
            <td>请检查输入的消息大小。</td>
            </tr>
            <tr>
            <td>660500002</td>
            <td>消息发送者未登录 SDK。</td>
            <td>请登录 ZIM SDK 后再发送消息。</td>
            </tr>
            <tr>
            <td>660500003</td>
            <td>调用 SendMessageToAllUsers 接口的频率超出限制。</td>
            <td>请稍后再试。</td>
            </tr>
            </tbody></table>

          example: 0
        Message:
          type: string
          description: 请求结果的说明信息。
          example: "success"
        RequestId:
          type: string
          description: 请求 ID。
          example: "343649807833778782"
      description: 仅返回通用三段，无 Data。
      example:
        Code: 0
        Message: "success"
        RequestId: "343649807833778782"
