# AI 对话 SDK 端回调

## 前提条件

已按照 [快速开始](./../quick-start.mdx) 文档集成 ZEGO Express SDK 和 AI Agent 并实现基本的语音通话功能。

## 描述
用户与Agent进行语音对话期间，服务端通过RTC房间自定义消息下发一些状态信息，比如用户说话状态、智能体说话状态、ASR识别的文本、大模型回答的文本。客户端监听房间自定义消息，解析对应的状态事件来渲染UI。


## 监听回调
Web 端通过注册 `recvExperimentalAPI` 回调来接收 AI 相关的状态和消息通知。

参考如下代码实现消息接收：

```javascript
zg.on("recvExperimentalAPI", (result) => {
  const { method, content } = result;
  if (method === "onRecvRoomChannelMessage") {
    try {
      // Parse the message
      const recvMsg = JSON.parse(content.msgContent);
      const { Cmd, SeqId, Data, Round } = recvMsg;
      console.log("Received message:", recvMsg);
    } catch (error) {
      console.error("Failed to parse the message:", error);
    }
  }
});

// Enable the experimental API for onRecvRoomChannelMessage
zg.callExperimentalAPI({ method: "onRecvRoomChannelMessage", params: {} });
```

## 协议说明

### MessageContent 协议

| 参数 | 类型 | 描述 |
| :--- | :--- | :--- |
| Timestamp | Int64 | 秒级时间戳。 |
| SeqId | int64 | 包序列号，保证有序性，不保证连续性。 |
| Round | int64 | 对话轮次，每次用户主动说话，轮次增加。保证有序性，不保证连续性。 |
| Cmd | Int | 命令字，标识消息类型。<br/>1: 用户说话状态<br/>2: 智能体说话状态 （已废弃）<br/>3: 识别的ASR文本<br/>4: LLM文本，大模型回答文本，增量下发<br/>6: 智能体状态 |
| Data | Object | 具体内容。见下方 Data 说明。 |

### Data 参数说明

根据 `Cmd` 的不同，`Data` 包含不同的字段。

#### Cmd = 1 (用户说话状态)

| 参数 | 类型 | 描述 |
| :--- | :--- | :--- |
| SpeakStatus | int | 1：说话开始，2: 说话结束 |

#### Cmd = 2 (智能体说话状态 - 已废弃)

| 参数 | 类型 | 描述 |
| :--- | :--- | :--- |
| SpeakStatus | int | 1：说话开始，2: 说话结束 |

#### Cmd = 3 (ASR 文本)

每次下发识别到的全量文本，支持文本纠正。

| 参数 | 类型 | 描述 |
| :--- | :--- | :--- |
| Text | string | 用户语音 asr 文本 |
| MessageId | string | 消息 id。每轮 asr 文本消息 id 唯一。 |
| EndFlag | bool | 结束标识。true 表示本轮 asr 文本已发送结束。 |

#### Cmd = 4 (LLM 文本)

每次下发增量文本答案。

| 参数 | 类型 | 描述 |
| :--- | :--- | :--- |
| Text | string | llm 文本 |
| MessageId | string | 消息 id。每轮 llm 文本消息 id 唯一。 |
| EndFlag | bool | 结束标识。true 表示本轮 llm 文本已发送结束。 |

#### Cmd = 6 (智能体状态)

| 参数 | 类型 | 描述 |
| :--- | :--- | :--- |
| Status | int | 0：空闲<br/>1：正在听<br/>2: 正在想<br/>3: 正在说 |
| OldStatus | int | 上一次状态，取值同 Status |
| Reason | string | 切换状态原因 |

## 示例消息

```javascript
{
  "Timestamp": 1712760000,
  "SeqId": 1,
  "Round": 1,
  "Cmd": 1,
  "Data": {
    "SpeakStatus": 1
  }
}
```