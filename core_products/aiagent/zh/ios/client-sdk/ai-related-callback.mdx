# 智能体实例SDK端回调

AIAgent 对话提供了丰富的状态回调功能。这些状态回调通过 Express SDK 的 [监听房间自定义消息](./display-subtitles.mdx#监听房间自定义消息) 发送，使得在客户端上可以方便地实现丰富的状态切换，例如"聆听中"、"思考中"、“说话中”等状态。
通过 Express SDK 接收自定义消息功能，在客户端上监听回调来接收实时 AI 状态的数据。
 

### 功能特点
实时性：状态变化可以实时传递给所有参与者。<br /> 
灵活性：使用自定义消息格式，便于集成和扩展。<br />
多状态支持：包括聆听、思考、说话和被打断等多种状态。


### 消息格式
状态回调自定义消息使用 JSON 格式，状态信息包含在字段msg_content中，里面包含字段如下：

| 参数 | 类型 | 描述 |
|------|------|------|
| Timestamp | int64 | 秒级时间戳。 |
| TimestampMs | int64 | 毫秒级时间戳。 |
| Seqld | int64 | 包序列号，保证有序性，不保证连续性 |
| Round | int64 | 对话轮次，每次用户主动说话，轮次增加。保证有序性，不保证连续性 |
| Cmd | Int | 1: 用户说话状态<br />3: 识别的ASR文本<br />4: LLM文本，大模型回答文本，增量下发<br />6: 智能体状态 |
| Data | Object | 具体内容。见Data |

#### Data:
##### Cmd=1,用户说话状态

| 参数 | 类型 | 描述 |
|------|------|------|
| SpeakStatus | int64 | 1：说话开始，2: 说话结束 |
| UserId | string | 说话用户UserID |

<Accordion title="示例消息" defaultOpen="false">
```json
{"method":"liveroom.room.on_recive_room_channel_message","params":{"msg_content":"{\"Timestamp\":1765510379,\"TimestampMs\":1765510379113,\"SeqId\":278800715,\"Round\":510359002,\"Cmd\":1,\"Legacy\":false,\"Data\":{\"SpeakStatus\":1,\"UserId\":\"38475\"}}","msg_type":1,"roomid":"ir_20p158E0","send_idname":"@RBT#38475_xiaozhi-sx_174722027","send_nickname":""}}
```
</Accordion>


##### Cmd=3,识别的ASR（用户说话）文本

| 参数 | 类型 | 描述 |
|------|------|------|
| Text | string | 用户语音识别结果文本<br />每次下发识别到的全量文本（整句是否结束，由EndFlag标志决定），支持文本纠正 |
| MessageId | string | 消息 id。每轮 asr 文本消息 id 唯一 |
| UserId | string | 说话用户UserID |
| StartFlag | bool | 结束标识。true 表示本轮 asr 文本已开始发送 |
| EndFlag | bool | 结束标识。true 表示本轮 asr 文本已发送结束,false表示后续还会有识别数据 |

<Accordion title="示例消息" defaultOpen="false">
```json
:{"method":"liveroom.room.on_recive_room_channel_message","params":{"msg_content":"{\"Timestamp\":1765510386,\"TimestampMs\":1765510386723,\"SeqId\":278820712,\"Round\":510359003,\"Cmd\":3,\"Legacy\":false,\"Data\":{\"MessageId\":\"2051951657\",\"UserId\":\"38475\",\"Text\":\"你在哪里？\",\"StartFlag\":false,\"EndFlag\":true}}","msg_type":1,"roomid":"ir_20p158E0","send_idname":"@RBT#38475_xiaozhi-sx_174722027","send_nickname":""}}
```
</Accordion>


由于网络传输异步性及不能确保100%完整性，Cmd=3的情况实现建议客户参考:[监听房间自定义消息](./display-subtitles.mdx)


##### Cmd=4,智能体应答文本

| 参数 | 类型 | 描述 |
|------|------|------|
| Text | string | 应答文本，每次下发增量文本答案 |
| MessageId | string | 消息 id。每轮应答文本消息 id 唯一 |
| EndFlag | bool | 结束标识。true 表示本轮 llm 文本已发送结束。 |

<Accordion title="示例消息" defaultOpen="false">
```json
:{"method":"liveroom.room.on_recive_room_channel_message","params":{"msg_content":"{\"Timestamp\":1765510387,\"TimestampMs\":1765510387545,\"SeqId\":278828066,\"Round\":510359003,\"Cmd\":4,\"Legacy\":false,\"Data\":{\"MessageId\":\"2052097919\",\"UserId\":\"@RBT#38475_xiaozhi-sx_174722027\",\"Text\":\"我在数字世界随时等你哦 无论你想谈天说\",\"StartFlag\":true,\"EndFlag\":false}}","msg_type":1,"roomid":"ir_20p158E0","send_idname":"@RBT#38475_xiaozhi-sx_174722027","send_nickname":""}}
```
</Accordion>

由于网络传输异步性及不能确保100%完整性，Cmd=4的情况实现建议客户参考:[监听房间自定义消息](./display-subtitles.mdx)


##### Cmd=6,智能体状态

| 参数 | 类型 | 描述 |
|------|------|------|
| Status | int | 0：空闲<br />1：正在听<br />2: 正在想<br />3: 正在说 |
| OldStatus | int | 上一次状态，同上  Status|
| Reason | string | 切换状态原因。 |

<Accordion title="示例消息" defaultOpen="false">
```json
:{"method":"liveroom.room.on_recive_room_channel_message","params":{"msg_content":"{\"Timestamp\":1765510398,\"TimestampMs\":1765510398029,\"SeqId\":278800725,\"Round\":0,\"Cmd\":6,\"Legacy\":false,\"Data\":{\"OldStatus\":3,\"Status\":0,\"Reason\":\"tts_all_played\"}}","msg_type":1,"roomid":"ir_20p158E0","send_idname":"@RBT#38475_xiaozhi-sx_174722027","send_nickname":""}}
```
</Accordion>

##### 自定义消息体其它可能用到参数介绍
| 参数 | 类型 | 描述 |
|------|------|------|
| msy_type | int | 1：表示房间自定义消息 |
| roomid | string | 房间id |
| send_idname | string | 自定义消息发送者userId |
| send_nickname | string | 自定义消息发送者昵称 |

### 应用场景
UI 反馈：根据不同状态显示相应的界面元素，如“正在聆听”的动画。<br />
交互控制：在 AI 思考或说话时，可以禁用某些用户输入以避免中断。<br />
调试与分析：利用状态信息进行会话分析，优化用户体验。