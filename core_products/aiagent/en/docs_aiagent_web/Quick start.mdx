# 快速开始

本文档用于说明如何快速实现与 AI Agent 的语音互动。

## 前提条件

- 已在 [ZEGO 控制台](https://console.zego.im/) 创建项目，并申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目信息](https://doc-zh.zego.im/article/12107)。
- 联系 ZEGO 技术支持开通 AI Agent 相关服务并获取 LLM 和 TTS 相关配置信息。
- 已经集成了支持 AI 降噪的 [ZEGO Express SDK](https://doc-zh.zego.im/article/6839)。
- 已部署业务后台并实现调用 AI Agent 相关接口（可参考服务端示例代码）。
<Note title="说明">
文本转语音（TTS）服务供应商。可选：Aliyun：阿里云、Bytedance：火山引擎、Minimax：MiniMax。

详情请参考 [TTS 参数](/aiagent-server/common-parameter-description#tts)说明文档。
</Note>
<Warning title="注意">请联系 ZEGO 技术支持获取支持 AI 降噪的 ZEGO Express SDK 版本，并在集成使用时开启  AI 降噪和 AI 回声消除以获得更好的语音交互效果。</Warning>


## 示例代码
以下是实现核心能力所需要的示例代码，您可以参考示例代码来实现自己的业务逻辑。

<CardGroup cols={2}>
<Card title="Web 客户端示例代码" href="https://github.com/ZEGOCLOUD/ai_agent_quick_start/tree/master/web" target="_blank">
Web 客户端示例代码。包含最基本的登录、推流、拉流、退出房间等能力。
</Card>
<Card title="服务端示例代码"  href="https://github.com/ZEGOCLOUD/ai_agent_quick_start_server" target="_blank">
服务端示例代码。包含最基本的获取 ZEGO Token、注册智能体、创建智能体实例、删除智能体实例等能力。
</Card>
</CardGroup>

## 整体业务流程图

您需要使用 ZEGO Express SDK 实现真实用户进入房间并推流。然后使用 AI Agent 提供的服务端 API 接口，实现将智能体加入房间并与真实用户进行实时互动。

```mermaid
sequenceDiagram
    participant 客户端
    participant 业务后台
    participant AI Agent后台
    
    客户端->>客户端: 初始化 ZEGO Express SDK
    
    客户端->>业务后台: 注册智能体
    业务后台->>AI Agent后台: 注册智能体
    AI Agent后台-->>业务后台: 
    业务后台-->>客户端: 
    
    客户端->>业务后台: 获取 Token
    业务后台-->>客户端: Token
    
    客户端->>客户端: 用户使用 Token 登录房间并推流
    
    客户端->>业务后台: 创建智能体实例
    业务后台->>AI Agent后台: 创建智能体实例
    AI Agent后台->>AI Agent后台: 智能体登录房间并推流、拉用户流
    AI Agent后台-->>业务后台: 
    业务后台-->>客户端: 
    
    
    客户端->>客户端: 用户拉智能体流
    
    客户端->>业务后台: 删除智能体实例
    业务后台->>AI Agent后台: 删除智能体实例
    AI Agent后台-->>业务后台: 
    业务后台-->>客户端: 
    
    客户端->>客户端: 用户停止推流并退出房间
```

## 核心能力实现


<Steps>
<Step title="初始化 ZEGO Express SDK">

以下是初始化 ZEGO Express SDK 的关键步骤：

1. 加载AI降噪模块
2. 实例化 ZegoExpressEngine
3. 检查系统要求（WebRTC 支持和麦克风权限）
```javascript {7,9,11}
import { ZegoExpressEngine } from "zego-express-engine-webrtc";
import { VoiceChanger } from "zego-express-engine-webrtc/voice-changer";

const appID = 1234567 // 从即构控制台获取
const server = 'xxx' // 从即构控制台获取
// 加载AI降噪模块
ZegoExpressEngine.use(VoiceChanger);
// 实例化 ZegoExpressEngine传入appId和server等配置
const zg = new ZegoExpressEngine(appID, server);
// 检查系统要求
const checkSystemRequirements = async () => {
    // 检测是否支持webRTC
    const rtc_sup = await zg.checkSystemRequirements("webRTC");
    if (!rtc_sup.result) {
      // 浏览器不支持webrtc
  }
    // 检测是否开启麦克风权限
    const mic_sup = await zg.checkSystemRequirements("microphone");
    if (!mic_sup.result) {
      // 未开启麦克风权限
  }
}
checkSystemRequirements()
```

更详细说明请参考 [集成 SDK](https://doc-zh.zego.im/article/6839) 和 [实现音频通话](https://doc-zh.zego.im/article/9540)。

</Step>
<Step title="注册智能体">
注册智能体用于设定智能体基础配置，包括智能体名称、LLM、TTS、ASR等相关配置。注册后可以该智能体作为模板创建多个实例与多个真实用户进行互动。

通常智能体是相对比较固定的，一旦设定好智能体的相关参数（人设形象）就不会经常改动。所以建议按照业务流程需要在初始化应用时或者其他其他步骤注册智能体即可。

<Note title="说明">一个智能体只能注册一次（同一个ID），如果重复注册会返回错误码 410001008。</Note>

以下是调用业务后台接口实现注册智能体的示例：
```javascript {3,8-11}
async function registerAgent(agentId, agentName) {
  try {
    const response = await fetch(`${BASE_URL}/api/agent/register`, { // BASE_URL 为您的业务后台地址
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        agent_id: agentId,
        agent_name: agentName
      }),
    });
    
    const data = await response.json();
    console.log('注册AI Agent结果:', data);
    return data;
  } catch (error) {
    console.error('注册AI Agent失败:', error);
    throw error;
  }
}
```
</Step>
<Step title="用户进入房间并推流">
用户登录房间后推流。注意在此场景下需要开启 AI 降噪以获得更好的效果。
登录用的 token 需要从业务后台获取，请参考完整示例代码。

<Note title="说明">
请确保 roomID、userID、streamID 在一个 ZEGO APPID 下是唯一的。
- roomID: 由用户自己定义生成规则,会用来登录 Express SDK 的房间。仅支持数字，英文字符 和 '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '_', '+', '=', '-', '`', ';', '’', ',', '.', '\<', '\>', ''。如果需要与 Web SDK 互通，请不要使用 '%'。
- userID: 长度不超过32字节。仅支持数字，英文字符 和 '~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '_', '+', '=', '-', '`', ';', '’', ',', '.', '\<', '\>', '\'。如果需要与 Web SDK 互通，请不要使用 '%'。
- streamID: 长度不超过256字节。仅支持数字，英文字符 和 '-', '_'。
</Note>

```javascript {22-25}
const userId = "" // 登录 Express SDK房间用户ID
const roomId = "" // RTC 房间 ID
const userStreamId = "" // 用户推流 ID
async function enterRoom() {
  try {
    // 生成 RTC Token [参考文档]（https://doc-zh.zego.im/article/7646）
    const token = await Api.getToken();
    // 登录房间
    await zg.loginRoom(roomId, token, {
      userID: userId,
      userName: "",
    });

    // 创建本地音频流
    const localStream = await zg.createZegoStream({
      camera: {
        video: false,
        audio: true,
      },
    });
    if (localStream) {
      // 推送本地流
      await zg.startPublishingStream(userStreamId, localStream);
      // 开启Ai降噪（需要特殊编包的 ZEGO Express SDK）
      const enableResult = await zg.enableAiDenoise(localStream, true);
      if (enableResult.errorCode === 0) {
        return zg.setAiDenoiseMode(localStream, 1);
      }
    }
  } catch (error) {
    console.error("进入房间失败:", error);
    throw error;
  }
}
enterRoom()
```
</Step>
<Step title="创建智能体实例">
可以用已注册的智能体为模板创建多个智能体实例加入不同房间与不同用户进行实时互动。创建智能体实例后，智能体实例会自动登录房间并推流，同时也会拉真实用户的流。

创建智能体实例成功后，真实用户监听流变化事件并拉流就可以与智能体进行实时互动了。

以下是调用业务后台接口实现创建智能体实例的示例：

<CodeGroup>

```javascript 创建智能体示例 {3,8-16}
async function createAgentInstance(agentId, roomId, userId, userStreamId, agentStreamId, agentUserId, messages = []) {
  try {
    const response = await fetch(`${BASE_URL}/api/agent/create`, { // BASE_URL 为您的业务后台地址
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        agent_id: agentId,
        room_id: roomId,
        user_id: userId,
        user_stream_id: userStreamId,
        agent_stream_id: agentStreamId,
        agent_user_id: agentUserId,
        messages: messages
      }),
    });
    
    const data = await response.json();
    console.log('创建AI Agent实例结果:', data);
    return data;
  } catch (error) {
    console.error('创建AI Agent实例失败:', error);
    throw error;
  }
}

```
```javascript 拉流示例 {9}
// 监听远端流更新事件
function setupEvent() {
  zg.on("roomStreamUpdate",
    async (roomID, updateType, streamList) => {
      if (updateType === "ADD" && streamList.length > 0) {
        try {
          for (const stream of streamList) {
            // 拉智能体流
            const mediaStream = await zg.startPlayingStream(stream.streamID);
            if (!mediaStream) return;
            const remoteView = await zg.createRemoteStreamView(mediaStream);
            if (remoteView) {
             // 这里需要页面上有个id为remoteSteamView的容器接收智能体流 [参考文档]（https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~class~ZegoStreamView）
              remoteView.play("remoteSteamView", {
                enableAutoplayDialog: false,
              });
            }
          }
        } catch (error) {
          console.error("拉流失败:", error);
        }
      }
    }
  );
}
```
</CodeGroup>

</Step>
<Step title="用户退出房间并删除智能体实例">
删除智能体实例后，智能体实例会自动退出房间并停止推流。用户再停止推流和退出房间后，一次完整的互动就结束了。

以下是调用业务后台接口实现删除智能体实例的示例：
```javascript {4,10,17-22}
// agentInstanceId 在创建智能体实例接口返回
async function deleteAgentInstance(agentInstanceId) {
  try {
    const response = await fetch(`${BASE_URL}/api/agent/delete`, { // BASE_URL 为您的业务后台地址
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        agent_instance_id: agentInstanceId
      }),
    });
    
    const data = await response.json();
    console.log('删除AI Agent实例结果:', data);

    // 销毁本地流
    await zg.destroyStream(localStream);
    // 退出房间
    await zg.logoutRoom(roomId);
    // 销毁Express引擎
    zg.destroyEngine();
  } catch (error) {
    console.error('删除AI Agent实例失败:', error);
    throw error;
  }
}
```

</Step>
</Steps>
