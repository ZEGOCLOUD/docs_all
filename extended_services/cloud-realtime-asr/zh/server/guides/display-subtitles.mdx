# 展示字幕

---

本文介绍如何展示用户在通过智能体进行语音翻译过程中的字幕。如下：

- 用户说话内容：流式展示用户正在说的话（语音识别（ASR）的实时结果）
- 智能体翻译内容：流式展示智能体输出的内容（大语言模型（LLM）实时翻译的输出结果）
// TODO: 这里图片要更换
<Frame width="auto" height="512" caption="">
  <img src="https://media-resource.spreading.io/docuo/workspace564/27e54a759d23575969552654cb45bf89/a78bc0cbf0.png" alt="subtitle.png"/>
</Frame>

## 前提条件

已按照 [快速开始](./../quick-start.mdx) 文档集成 ZEGO Express SDK 和 Cloud ASR 并实现基本的语音通话功能。

<Warning title="注意">
必须使用[下载 SDK 及 Demo](./../introduction/download.mdx)页面针对 Cloud ASR 优化的 ZEGO Express SDK 版本，否则无法正常显示字幕。
</Warning>

### 使用字幕组件
<Tabs>
<Tab title="iOS">
//TODO: 这里项目地址要换
您可以直接下载[字幕组件源码](https://github.com/ZEGOCLOUD/ai_agent_quick_start/tree/master/ios/ai_agent_quickstart/aiagent/audio/subtitles)到您的项目中直接使用。

<Accordion title="字幕组件使用示例" defaultOpen="true">
<CodeGroup>
```objectivec YourView.h
#import <UIKit/UIKit.h>
#import "ZegoAIAgentSubtitlesEventHandler.h"

NS_ASSUME_NONNULL_BEGIN

@interface YourView : UIView <ZegoAIAgentSubtitlesEventHandler>

@end
```

```objectivec YourView.m {5-6,10-11,20-23,25-26,34-35,56-57,61-62,67-69,73-75,77-79}
#import "YourView.h"

#import <Masonry/Masonry.h>

#import "ZegoCloudAsrSubtitlesTableView.h"
#import "ZegoCloudAsrSubtitlesMessageDispatcher.h"

@interface YourView() <ZegoAIAgentAudioEventHandler, ZegoAIAgentSubtitlesEventHandler>

// 智能体字幕
@property (nonatomic, strong, readwrite) ZegoCloudAsrSubtitlesTableView *subtitlesTableView;

@end

@implementation YourView

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        // 设置自己的用户 Id
        ZegoCloudAsrServiceAPI.sharedInstance().setUserId(userID)
        // 预设房间 Id（若不设置则会随机房间 Id）
        ZegoCloudAsrServiceAPI.sharedInstance().setRoomId(roomID)

        // 注册事件
        [self registerEventHandler];

        [self setupSubtitles];
    }
    return self;
}

- (void)dealloc {
    // 反注册事件
    [self unregisterEventHandler];
}

- (void)setupSubtitles {
    // 添加聊天视图 - 占据屏幕下半部分
    CGRect chatFrame = CGRectMake(0,
                                 self.bounds.size.height / 2,
                                 self.bounds.size.width,
                                 self.bounds.size.height / 2);
    self.subtitlesTableView = [[ZegoCloudAsrSubtitlesTableView alloc] initWithFrame:chatFrame style:UITableViewStylePlain];

    [self addSubview:self.subtitlesTableView];

    // 使用 Masonry 添加约束
    [self.subtitlesTableView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.bottom.equalTo(self);
        make.height.equalTo(self.mas_height).multipliedBy(0.5);
    }];
}

- (void)registerEventHandler {
    [[ZegoCloudAsrServiceAPI sharedInstance] registerAudioEventHandler:self];
    [[ZegoCloudAsrSubtitlesMessageDispatcher sharedInstance] registerEventHandler:self];
}

- (void)unregisterEventHandler {
    [[ZegoCloudAsrSubtitlesMessageDispatcher sharedInstance] unregisterEventHandler:self];
    [[ZegoCloudAsrServiceAPI sharedInstance] unregisterAudioEventHandler:self];
}

#pragma mark - ZegoAIAgentAudioEventHandler

- (void)onRecvExperimentalAPI:(NSString *)content{
    [[ZegoCloudAsrSubtitlesMessageDispatcher sharedInstance] handleExpressExperimentalAPIContent:content];
}

#pragma mark - ZegoAIAgentSubtitlesEventHandler

- (void)onRecvAsrChatMsg:(ZegoAIAgentAudioSubtitlesMessage *)message {
    [self.subtitlesTableView handleRecvAsrMessage:message];
}

- (void)onRecvLLMChatMsg:(ZegoAIAgentAudioSubtitlesMessage *)message {
    [self.subtitlesTableView handleRecvLLMMessage:message];
}

@end
```
</CodeGroup>
</Accordion>
</Tab>

<Tab title="Android">
您可以直接下载[字幕处理类源码](https://github.com/ZEGOCLOUD/ai_agent_quick_start/blob/master/android/QuickStart/app/src/main/java/im/zego/aiagent/express/quickstart/voice/AudioChatMessageParser.java)到您的项目中直接使用。
<Accordion title="字幕处理类使用示例" defaultOpen="true">
```java {8-9}
private AudioChatMessageParser audioChatMessageParser = new AudioChatMessageParser();

ZegoExpressEngine.getEngine().setEventHandler(new IZegoEventHandler() {
    @Override
    public void onRecvExperimentalAPI(String content) {
        super.onRecvExperimentalAPI(content);
      
        // AudioChatTextMessage 会解析 JSON 字符串
        audioChatMessageParser.onRecvExperimentalAPI(content);
    }
});

audioChatMessageParser.setAudioChatMessageListListener(new AudioChatMessageListListener() {
    @Override
    public void onMessageListUpdated(List<AudioChatMessage> messagesList) {
        // 更新 UI 列表
        binding.messageList.onMessageListUpdated(messagesList);
    }
});
```
</Accordion>
</Tab>

<Tab title="Web">
如果您是 Vue 项目，可以直接下载[字幕处理hook](https://github.com/ZEGOCLOUD/ai_agent_quick_start/blob/master/web/src/hooks/useChat.ts)到您的项目中直接使用。
<Accordion title="Vue 项目字幕处理hook使用示例" defaultOpen="true">
```javascript
// 使用字幕组件示例代码
// 在页面中引入chatHook
import { useChat } from "useChat";
import { onMounted, onBeforeUnmount } from 'vue';

// 调用useChat方法，传入 Express SDK 实例，messages为消息列表，放入你的字幕组件中进行渲染
const { messages, setupEventListeners, clearMessages } = useChat(zg);

onMounted(() => {
  // 页面加载时，注册事件监听
  setupEventListeners()
})

onBeforeUnmount(() => {
 // 页面销毁时，清空消息
 clearMessages()
})

```
</Accordion>
</Tab>
</Tabs>

## 字幕展示时如何筛选

### 理解房间自定义消息协议

房间自定义消息的各字段说明如下：

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| Timestamp | Number | 时间戳，秒级别 |
| SeqId | Number | 包序列号，可能乱序，请根据序列号对消息进行排序。极端情况下 Id 可能不连续。 |
| Round | Number | 对话轮次，每次用户主动说话轮次增加 |
| Cmd | Number | 201: 语音识别（ASR）的文本<br/>202: LLM 翻译的文本 |
| Data | Object | 具体内容，各 Cmd 对应不同 Data |

Cmd 不同对应的 Data 也不同，具体如下：

<Tabs>
<Tab title="Cmd 为 201">

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| UserId | string | 用户 id |
| Text | string | 用户语音识别（ASR）的文本<br/>每次下发的是全量文本，支持文本修正 |
| MessageId | string | 消息 id，每轮 ASR 文本消息 id 唯一 |
| EndFlag | bool | 结束标识，true 表示本轮 ASR 文本已处理完成 |

</Tab>
<Tab title="Cmd 为 202">

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| UserId | string | 用户 id |
| Text | string | LLM 翻译文本<br/>每次下发增量文本 |
| MessageId | string | 消息 id，每轮 LLM 翻译文本消息 id 唯一 |
| EndFlag | bool | 结束标识，true 表示本轮 LLM 翻译文本已处理完成 |

</Tab>
</Tabs>


### 处理流程

根据 Cmd 字段判断消息类型，并根据 Data 字段获取消息内容。
<Tabs>
<Tab title="Cmd 为 201，ASR 文本">
对应消息处理流程如下图所示：
<Frame width="512" height="auto" caption="">
  <img src="https://media-resource.spreading.io/docuo/workspace564/27e54a759d23575969552654cb45bf89/3ed1100592.png" alt="cmd3.png"/>
</Frame>

</Tab>

<Tab title="Cmd 为 202，LLM  翻译文本">
对应消息处理流程如下图所示。其中：
- AI 消息缓存：一个 HashMap，key 为 MessageId，value 为新消息。
- UI 消息列表：包含用户消息和 AI 消息的数组，存储所有在 UI 上展示的消息。
<Frame width="512" height="auto" caption="">
  <img src="https://media-resource.spreading.io/docuo/workspace564/27e54a759d23575969552654cb45bf89/6720b5a0af.png" alt="cmd4.png"/>
</Frame>
</Tab>
</Tabs>

### 筛选逻辑

如果想在通话时仅显示对方的识别和翻译字幕，那么可以按以下方案进行修改。

<Tabs>
<Tab title="iOS">
```objectivec ZegoCloudAsrSubtitlesMessageDispatcher.m {7-11,15-19}
- (void)handleMessageContent:(NSString *)msgContent userID:(NSString *)userID userName:(NSString *)userName {
  ......

  if (cmd == ZegoCloudAsrMessageCmdAsrText && messageProtocol.asrTextData) {
    ......

    // 将自定义消息中的 UserId 字段与自己的 UserId 做比较
    if (NO == [userId isEqualToString:[[ZegoCloudAsrServiceAPI sharedInstance] getUserId]]) {
      [ZegoCloudAsrLogUtil write:[NSString stringWithFormat:@"dispatchAsrChatMsg, seqId=%llu, round=%llu, message_id=%@", seqId, round, message_id]];
      [self dispatchAsrChatMsg:cmdMsg];
    }
  } else if (cmd == ZegoCloudAsrMessageCmdLlmText && messageProtocol.llmTextData) {
    ......

    // 将自定义消息中的 UserId 字段与自己的 UserId 做比较
    if (NO == [userId isEqualToString:[[ZegoCloudAsrServiceAPI sharedInstance] getUserId]]) {
        [ZegoCloudAsrLogUtil write:[NSString stringWithFormat:@"dispatchLLMChatMsg, seqId=%llu, round=%llu, message_id=%@", seqId, round, message_id]];
        [self dispatchLLMChatMsg:cmdMsg];
    }
  }
}
```
</Tab>
</Tabs>
